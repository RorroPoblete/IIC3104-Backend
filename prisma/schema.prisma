// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuarios autorizados para ingresar y operar en el sistema
model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
  @@map("users")
// Logs de auditoría para cambios de datos y operaciones administrativas
model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  userId      String?
  userEmail   String?
  userName    String?
  description String?
  before      Json?
  after       Json?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([action])
  @@index([userEmail])
  @@index([createdAt])
}

// Tabla para controlar lotes de importación
model ImportBatch {
  id          String   @id @default(cuid())
  filename    String
  status      ImportStatus @default(PENDING)
  totalRows   Int?
  processedRows Int @default(0)
  errorRows   Int @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?

  // Relaciones
  stagingRows ImportStagingRow[]
  normalizedData NormalizedData[]

  @@map("import_batches")
}

// Tabla de staging para recibir el CSV tal cual
model ImportStagingRow {
  id        String @id @default(cuid())
  batchId   String
  rowNumber Int
  rawData   Json   // Almacena toda la fila como JSON

  // Relaciones
  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("import_staging_rows")
}

// Modelo normalizado mínimo para aplicar el lote
model NormalizedData {
  id        String @id @default(cuid())
  batchId   String

  // Campos principales del episodio
  episodioCmbd           String?
  edadAnos              Int?
  sexo                  String?
  conjuntoDx            String?
  tipoActividad         String?
  tipoIngreso           String?
  servicioIngresoDesc   String?
  servicioIngresoCod    String?
  motivoEgreso          String?
  medicoEgreso          String?
  especialidadEgreso    String?
  servicioEgresoCod     String?
  servicioEgresoDesc    String?
  
  // Previsión
  previsionCod          String?
  previsionDesc         String?
  prevision2Cod         String?
  prevision2Desc        String?
  
  // Ley y convenios
  leyCod                String?
  leyDesc               String?
  conveniosCod          String?
  conveniosDesc         String?
  
  // Servicio de salud
  servicioSaludCod      String?
  servicioSaludDesc     String?
  
  // Estancias
  estanciasPrequirurgicas Float?
  estanciasPostquirurgicas Float?
  emPreQuirurgica       Float?
  emPostQuirurgica      Float?
  estanciaEpisodio      Float?
  estanciaRealEpisodio  Float?
  horasEstancia         Float?
  estanciaMedia         Float?
  
  // GRD
  pesoGrdMedio          Float?
  pesoMedioNorma        Float?
  iemaIrBruto           Float?
  emafIrBruta           Float?
  impactoEstancias      Float?
  irGravedad            String?
  irMortalidad          String?
  irTipoGrd             String?
  irGrdCodigo           String?
  irGrd                 String?
  irPuntoCorteInferior  Float?
  irPuntoCorteSuperior  Float?
  emNorma               Float?
  estanciasNorma        Float?
  casosNorma            Float?
  
  // Fechas
  fechaIngresoCompleta  DateTime?
  fechaCompleta         DateTime?
  
  // Traslados
  conjuntoServiciosTraslado String?
  fechaTr1              DateTime?
  fechaTr2              DateTime?
  fechaTr3              DateTime?
  fechaTr4              DateTime?
  fechaTr5              DateTime?
  fechaTr6              DateTime?
  fechaTr7              DateTime?
  fechaTr8              DateTime?
  fechaTr9              DateTime?
  fechaTr10             DateTime?
  emTrasladosServicio   Float?
  
  // Facturación
  facturacionTotal      Float?
  especialidadMedica    String?
  irAltaInlier          String?
  
  // Metadatos
  anio                  Int?
  mes                   Int?
  diagnosticoPrincipal  String?
  proced01Principal     String?
  conjuntoProcedimientosSecundarios String?
  
  // Servicios de traslado
  servicioIngresoCod1   String?
  servicioCodTr1        String?
  servicioCodTr2        String?
  servicioCodTr3        String?
  servicioCodTr4        String?
  servicioCodTr5        String?
  servicioCodTr6        String?
  servicioCodTr7        String?
  servicioCodTr8        String?
  servicioCodTr9        String?
  servicioCodTr10       String?
  servicioEgresoCod2    String?

  // Datos enriquecidos desde Norma MINSAL
  pesoTotalNorma        Float?
  pesoTotalDepuNorma    Float?
  estMediaNorma         Float?
  gravedadNorma         String?
  tieneNorma            Boolean @default(false)

  // Campos de validación y control (Finanzas)
  validacion            String?  // Estado de validación
  estadoRN              String?  // Estado RN (Recién Nacido)
  diasDemora            Int?     // Días de demora/de espera

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("normalized_data")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

// Tabla para almacenar archivos de Norma Minsal
model NormaMinsalFile {
  id          String   @id @default(cuid())
  filename    String
  description String?
  status      ImportStatus @default(PENDING)
  totalRows   Int?
  processedRows Int @default(0)
  errorRows   Int @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  isActive    Boolean @default(false) // Solo un archivo puede estar activo a la vez

  // Relaciones
  data NormaMinsalData[]
  calculos CalculoEpisodio[]

  @@map("norma_minsal_files")
}

// Tabla para almacenar datos de Norma Minsal
model NormaMinsalData {
  id          String @id @default(cuid())
  fileId      String
 
  // Campos principales de la norma MINSAL basados en el CSV real
  grd                     String  // Código GRD - campo principal para matching
  tipoGrd                 String?
  gravedad                String?
  totalAltas              Int?
  totalEst                Float?
  estMedia                Float?
  altasDepu               Int?
  totalEstDepu            Float?
  estMediaDepuG           Float?
  numOutInfG              Int?
  nOutliersSup            Int?
  exitus                  Int?
  percentil25             Float?
  percentil50             Float?
  percentil75             Float?
  puntoCorteInferior      Float?
  puntoCorteSuperior      Float?
  pesoTotal               Float?
  pesoTotalDepu           Float?
  
  // Campos adicionales que puedan venir en el CSV
  rawData     Json   // Almacena toda la fila como JSON para flexibilidad
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  file NormaMinsalFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([grd])
  @@index([fileId])
  @@map("norma_minsal_data")
}

model PricingFile {
  id            String        @id @default(cuid())
  filename      String
  description   String?
  status        ImportStatus  @default(PENDING)
  totalRows     Int?
  processedRows Int            @default(0)
  errorRows     Int            @default(0)
  isActive      Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  completedAt   DateTime?

  tarifas PricingTarifa[]
  calculos CalculoEpisodio[]

  @@map("pricing_files")
}

model PricingTarifa {
  id                   String   @id @default(cuid())
  fileId               String
  aseguradoraCodigo    String?
  aseguradoraNombre    String?
  convenioId           String
  descripcionConvenio  String?
  tipoAseguradora      String?
  tipoConvenio         String?
  tramo                String?
  precio               Decimal  @db.Decimal(20, 4)
  fechaAdmision        DateTime?
  fechaFin             DateTime?
  rawData              Json
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  file PricingFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([convenioId])
  @@index([fileId])
  @@map("pricing_tarifas")
}

// Modelo para versionado de cálculos de episodios
model CalculoEpisodio {
  id                String   @id @default(cuid())
  episodioId        String   // ID del episodio normalizado
  version           Int      // Número de versión del cálculo (incremental)
  convenio          String?  // Código del convenio
  grd               String?  // Código GRD del episodio
  precioBase        Decimal? @db.Decimal(20, 4)
  ir                Decimal? @db.Decimal(20, 4) // Peso relativo/IR usado
  subtotal          Decimal? @db.Decimal(20, 4)
  totalFinal        Decimal  @db.Decimal(20, 4)
  breakdown         Json     // Breakdown completo del cálculo
  fechaReferencia   DateTime? // Fecha de referencia para el cálculo
  normaFileId       String?  // ID del archivo activo de norma usado
  pricingFileId     String?  // ID del archivo activo de pricing usado
  usuario           String?  // Usuario que ejecutó el cálculo
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  normaFile         NormaMinsalFile? @relation(fields: [normaFileId], references: [id])
  pricingFile       PricingFile? @relation(fields: [pricingFileId], references: [id])

  @@index([episodioId])
  @@index([episodioId, version])
  @@map("calculo_episodios")
}

// Modelo para auditoría de eventos de cálculo
model CalculoAuditoria {
  id            String   @id @default(cuid())
  evento        String   // Tipo de evento (ej: "Recalcular episodio (V1)")
  episodioId    String?  // ID del episodio relacionado
  calculoId     String?  // ID del cálculo relacionado
  usuario       String?  // Usuario que ejecutó la acción
  totalFinal    Decimal? @db.Decimal(20, 4)
  fuentes       Json?    // Información de fuentes usadas
  metadata      Json?    // Información adicional
  createdAt     DateTime @default(now())

  @@index([episodioId])
  @@index([calculoId])
  @@index([createdAt])
  @@map("calculo_auditoria")
}

// Tabla para almacenar archivos de Ajustes por Tecnología
model AjustesTecnologiaFile {
  id          String   @id @default(cuid())
  filename    String
  description String?
  status      ImportStatus @default(PENDING)
  totalRows   Int?
  processedRows Int @default(0)
  errorRows   Int @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  isActive    Boolean @default(false) // Solo un archivo puede estar activo a la vez

  // Relaciones
  data AjustesTecnologiaData[]

  @@map("ajustes_tecnologia_files")
}

// Tabla para almacenar datos de Ajustes por Tecnología
model AjustesTecnologiaData {
  id          String @id @default(cuid())
  fileId      String
  
  // Campos principales
  codigo      String  // Código(s) de procedimiento (puede ser múltiple separado por ;)
  descripcion String? // Descripción de la tecnología
  monto       Decimal @db.Decimal(20, 4) // Monto del ajuste
  
  // Campos adicionales
  rawData     Json   // Almacena toda la fila como JSON para flexibilidad
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  file AjustesTecnologiaFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([codigo])
  @@index([fileId])
  @@map("ajustes_tecnologia_data")
}
