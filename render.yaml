# render.yaml
# Corrected version for deployment on Render.

services:
  # 1. The Backend Web Service
  - type: web
    name: backend
    env: docker
    repo: https://github.com/your-username/your-repo-name.git # Be sure to update this!
    dockerfilePath: ./Dockerfile
    healthCheckPath: /api/health # Recommended: Add a health check endpoint
    plan: starter
    
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: CORS_ORIGIN
        value: ${RENDER_EXTERNAL_URL}
      - key: UPLOAD_PATH
        value: /app/uploads
      - key: MAX_FILE_SIZE
        value: 10485760
      - key: LOG_LEVEL
        value: info
      
      # Secrets (add these in the Render dashboard)
      - key: AUTH0_DOMAIN
        fromSecret: true
      - key: AUTH0_AUDIENCE
        fromSecret: true
      - key: AUTH0_CLIENT_ID
        fromSecret: true

      # Connection strings from Render's managed services
      - key: DATABASE_URL
        fromService:
          type: pserv
          name: healthdb-postgres
          property: internalConnectionString
      - key: REDIS_URL
        fromService:
          type: pserv
          name: healthdb-redis
          property: internalConnectionString

    disks:
      - name: backend-uploads
        mountPath: /app/uploads
        sizeGB: 1

  # 2. The Managed PostgreSQL Database (CORRECTED)
  - type: pserv
    name: healthdb-postgres
    env: postgres
    plan: free
    databaseName: healthdb # ✅ Correctly un-indented
    databaseUser: postgres    # ✅ Correctly un-indented

  # 3. The Managed Redis Instance
  - type: pserv
    name: healthdb-redis
    env: redis
    plan: free